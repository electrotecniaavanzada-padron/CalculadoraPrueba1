<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAVARSA - Calculadora Guía de Diseño de Iluminación para Nave Industrial Simple</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        /* Header SAVARSA actualizado */
        .header-savarsa {
            background: linear-gradient(135deg, #1a3a5f 0%, #2c5282 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #e63946;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: #e63946;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-text h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .logo-text .tagline {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .logo-text .tool-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e63946;
        }

        .contact-info {
            text-align: right;
            font-size: 0.9rem;
        }

        .contact-info p {
            margin-bottom: 5px;
        }

        .contact-info i {
            margin-right: 8px;
            color: #e63946;
        }

        /* Modal de datos del cliente */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #2c5282;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            color: #2c5282;
            font-size: 1.8rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Panel de proyectos guardados */
        .saved-projects {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .saved-projects h4 {
            color: #2c5282;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .saved-projects h4 i {
            color: #e63946;
        }

        .projects-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .project-item {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .project-item:hover {
            background-color: #e8f0fe;
        }

        .project-item.selected {
            background-color: #2c5282;
            color: white;
        }

        .project-name {
            font-weight: bold;
            color: #2c5282;
        }

        .project-item.selected .project-name {
            color: white;
        }

        .project-date {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .project-item.selected .project-date {
            color: #e0e0e0;
        }

        /* Contenido principal */
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 0;
        }

        .calculator-section {
            flex: 1;
            min-width: 400px;
            padding: 25px;
            border-right: 1px solid #eee;
        }

        .results-section {
            flex: 1.2;
            min-width: 500px;
            padding: 25px;
            background-color: #f9fafc;
        }

        .section-title {
            color: #2c5282;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e63946;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title i {
            margin-right: 10px;
            color: #e63946;
        }

        .form-group-calc {
            margin-bottom: 20px;
        }

        .form-group-calc label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c5282;
        }

        .form-group-calc input, .form-group-calc select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-group-calc input:focus, .form-group-calc select:focus {
            border-color: #2c5282;
            outline: none;
            box-shadow: 0 0 0 2px rgba(44, 82, 130, 0.2);
        }

        .range-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .reflectance-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .reflectance-option {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .reflectance-option:hover {
            border-color: #2c5282;
        }

        .reflectance-option.selected {
            border-color: #2c5282;
            background-color: #e8f0fe;
            border-width: 2px;
        }

        .reflectance-name {
            font-weight: bold;
            color: #2c5282;
            font-size: 0.9rem;
        }

        .reflectance-value {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .calculate-btn {
            background-color: #2c5282;
            color: white;
        }

        .calculate-btn:hover {
            background-color: #1a3a5f;
        }

        .reset-btn {
            background-color: #e0e0e0;
            color: #333;
        }

        .reset-btn:hover {
            background-color: #d0d0d0;
        }

        .export-btn {
            background-color: #27ae60;
            color: white;
        }

        .export-btn:hover {
            background-color: #219653;
        }

        .quote-btn {
            background-color: #e63946;
            color: white;
        }

        .quote-btn:hover {
            background-color: #c1121f;
        }

        .save-btn {
            background-color: #9b59b6;
            color: white;
        }

        .save-btn:hover {
            background-color: #8e44ad;
        }

        .result-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #2c5282;
        }

        .result-title {
            font-weight: 600;
            color: #2c5282;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #e63946;
            margin-bottom: 5px;
        }

        .result-detail {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .luminaire-model {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .luminaire-model:hover {
            background-color: #e8f0fe;
        }

        .luminaire-model.selected {
            border-left: 4px solid #2c5282;
            background-color: #e8f0fe;
        }

        .luminaire-icon {
            font-size: 1.5rem;
            color: #2c5282;
            margin-right: 15px;
        }

        .luminaire-info {
            flex: 1;
        }

        .luminaire-code {
            font-weight: bold;
            color: #2c5282;
        }

        .luminaire-specs {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .cost-analysis {
            margin-top: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .cost-title {
            color: #2c5282;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cost-title i {
            color: #27ae60;
            margin-right: 10px;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .cost-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .cost-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .cost-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #27ae60;
        }

        .cost-subtext {
            font-size: 0.85rem;
            color: #95a5a6;
            margin-top: 3px;
        }

        /* Vista de Planta 2D MEJORADA */
        .plant-view {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .plant-title {
            color: #2c5282;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .plant-title i {
            color: #e63946;
            margin-right: 10px;
        }

        .plant-container {
            width: 100%;
            height: 350px;
            position: relative;
            background-color: #fff;
            border: 2px solid #2c5282;
            border-radius: 5px;
            overflow: hidden;
        }

        .plant-floor {
            width: 100%;
            height: 100%;
            position: absolute;
            background-color: #f0f8ff;
        }

        .plant-luminaire {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #e63946;
            border-radius: 50%;
            border: 2px solid #2c5282;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .plant-wall {
            position: absolute;
            background-color: #2c5282;
            z-index: 5;
        }

        .plant-wall.horizontal {
            width: 100%;
            height: 4px;
        }

        .plant-wall.vertical {
            width: 4px;
            height: 100%;
        }

        /* Dimensiones mejoradas */
        .dimension-line {
            position: absolute;
            background-color: #e63946;
            z-index: 2;
        }

        .dimension-line.horizontal {
            height: 1px;
        }

        .dimension-line.vertical {
            width: 1px;
        }

        .dimension-text {
            position: absolute;
            font-size: 10px;
            color: #e63946;
            background-color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
            z-index: 20;
            border: 1px solid #e63946;
        }

        .dimension-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            z-index: 3;
        }

        .dimension-arrow.left {
            border-width: 4px 4px 4px 0;
            border-color: transparent #e63946 transparent transparent;
        }

        .dimension-arrow.right {
            border-width: 4px 0 4px 4px;
            border-color: transparent transparent transparent #e63946;
        }

        .dimension-arrow.top {
            border-width: 0 4px 4px 4px;
            border-color: transparent transparent #e63946 transparent;
        }

        .dimension-arrow.bottom {
            border-width: 4px 4px 0 4px;
            border-color: #e63946 transparent transparent transparent;
        }

        /* Líneas de separación entre luminarias */
        .separation-line {
            position: absolute;
            background-color: #3498db;
            z-index: 1;
            opacity: 0.6;
        }

        .separation-line.horizontal {
            height: 1px;
            width: 100%;
        }

        .separation-line.vertical {
            width: 1px;
            height: 100%;
        }

        .plant-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .legend-luminaire {
            background-color: #e63946;
        }

        .legend-dimension {
            background-color: #e63946;
        }

        .legend-separation {
            background-color: #3498db;
        }

        .client-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f0fe;
            border-radius: 8px;
            border-left: 4px solid #2c5282;
        }

        .client-summary h4 {
            color: #2c5282;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .client-summary h4 i {
            margin-right: 8px;
        }

        .client-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .client-info-item {
            font-size: 0.9rem;
        }

        .client-info-label {
            font-weight: bold;
            color: #2c5282;
        }

        .client-info-value {
            color: #333;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            background-color: #f8f9fa;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .results-grid .result-card {
            margin-bottom: 0;
        }

        .auto-save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }

        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .export-option {
            padding: 8px 15px;
            background-color: #2c5282;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .export-option:hover {
            background-color: #1a3a5f;
        }

        @media (max-width: 992px) {
            .content {
                flex-direction: column;
            }
            
            .calculator-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .header-savarsa {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .contact-info {
                text-align: center;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .plant-container {
                height: 300px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header SAVARSA actualizado -->
        <div class="header-savarsa">
            <div class="logo-container">
                <div class="logo-icon">
                    <i class="fas fa-industry"></i>
                </div>
                <div class="logo-text">
                    <h1>SAVARSA</h1>
                    <div class="tagline">Servicios Administrativos Varan</div>
                    <div class="tool-title">Calculadora Guía de Diseño de Iluminación para Nave Industrial Simple</div>
                </div>
            </div>
            <div class="contact-info">
                <p><i class="fas fa-phone"></i> Tel: 55 29005186</p>
                <p><i class="fas fa-envelope"></i> epadron@savarsa.com</p>
                <p><i class="fas fa-map-marker-alt"></i> Ciudad de México</p>
            </div>
        </div>

        <!-- Modal de datos del cliente -->
        <div class="modal-overlay" id="clientModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-tie"></i> Datos del Cliente y Proyecto</h2>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                
                <!-- Proyectos guardados -->
                <div class="saved-projects" id="savedProjectsSection" style="display: none;">
                    <h4>
                        <span><i class="fas fa-history"></i> Proyectos Guardados</span>
                        <button onclick="clearAllProjects()" style="background: none; border: none; color: #e63946; cursor: pointer;">
                            <i class="fas fa-trash"></i> Limpiar
                        </button>
                    </h4>
                    <div class="projects-list" id="projectsList">
                        <!-- Los proyectos se cargarán aquí -->
                    </div>
                </div>
                
                <form id="clientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientName">Nombre completo *</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-group">
                            <label for="clientCompany">Empresa</label>
                            <input type="text" id="clientCompany">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientEmail">Email *</label>
                            <input type="email" id="clientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Teléfono *</label>
                            <input type="tel" id="clientPhone" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="projectName">Nombre del Proyecto *</label>
                        <input type="text" id="projectName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="projectAddress">Dirección del Proyecto</label>
                        <input type="text" id="projectAddress">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectType">Tipo de Proyecto</label>
                            <select id="projectType">
                                <option value="industrial">Industrial</option>
                                <option value="comercial">Comercial</option>
                                <option value="almacen">Almacén</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="projectStatus">Estado del Proyecto</label>
                            <select id="projectStatus">
                                <option value="cotizacion">En cotización</option>
                                <option value="planeacion">En planeación</option>
                                <option value="ejecucion">En ejecución</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="projectNotes">Notas adicionales</label>
                        <textarea id="projectNotes" placeholder="Observaciones o requerimientos especiales..."></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="reset-btn" id="cancelForm">Cancelar</button>
                        <button type="submit" class="calculate-btn">Guardar y Continuar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notificación de auto-guardado -->
        <div class="auto-save-notification" id="autoSaveNotification">
            <i class="fas fa-check-circle"></i> Proyecto guardado automáticamente
        </div>

        <!-- Contenido principal -->
        <div class="content">
            <div class="calculator-section">
                <h2 class="section-title">
                    <span><i class="fas fa-calculator"></i> Datos del Proyecto</span>
                    <span style="font-size: 0.9rem; color: #27ae60; font-weight: normal;" id="lastSaveInfo"></span>
                </h2>
                
                <div class="client-summary" id="clientSummary" style="display: none;">
                    <h4>
                        <span><i class="fas fa-user-tie"></i> Información del Cliente</span>
                        <button onclick="editClientData()" style="background: none; border: none; color: #2c5282; cursor: pointer;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                    </h4>
                    <div class="client-info-grid" id="clientInfoGrid">
                        <!-- Información del cliente se llenará aquí -->
                    </div>
                </div>
                
                <div class="form-group-calc">
                    <label for="length">Longitud de la nave (m):</label>
                    <input type="number" id="length" min="1" max="200" step="0.5" value="30">
                    <div class="range-info">Min: 1m | Max: 200m</div>
                </div>
                
                <div class="form-group-calc">
                    <label for="width">Ancho de la nave (m):</label>
                    <input type="number" id="width" min="1" max="100" step="0.5" value="15">
                    <div class="range-info">Min: 1m | Max: 100m</div>
                </div>
                
                <div class="form-group-calc">
                    <label for="height">Altura del techo (m):</label>
                    <input type="number" id="height" min="2" max="30" step="0.5" value="6">
                    <div class="range-info">Min: 2m | Max: 30m</div>
                </div>
                
                <div class="form-group-calc">
                    <label for="work-plane">Altura del plano de trabajo (m):</label>
                    <input type="number" id="work-plane" min="0" max="5" step="0.1" value="0.8">
                    <div class="range-info">Generalmente entre 0.7m - 0.85m</div>
                </div>
                
                <div class="form-group-calc">
                    <label for="activity">Tipo de actividad (NOM-STPS-025):</label>
                    <select id="activity">
                        <option value="500">Almacenamiento general (500 lux)</option>
                        <option value="300">Almacenamiento pasivo (300 lux)</option>
                        <option value="750">Inspección visual (750 lux)</option>
                        <option value="1000">Trabajo de precisión media (1000 lux)</option>
                        <option value="1500">Trabajo de precisión fina (1500 lux)</option>
                        <option value="200">Circulación y zonas de paso (200 lux)</option>
                        <option value="300">Áreas de descanso (300 lux)</option>
                    </select>
                </div>
                
                <div class="form-group-calc">
                    <label>Factores de Reflectancia:</label>
                    <div class="reflectance-options">
                        <div class="reflectance-option" onclick="selectReflectance('alta')">
                            <div class="reflectance-name">Alta</div>
                            <div class="reflectance-value">Techo: 80% | Pared: 70% | Piso: 30%</div>
                        </div>
                        <div class="reflectance-option selected" onclick="selectReflectance('media')">
                            <div class="reflectance-name">Media</div>
                            <div class="reflectance-value">Techo: 70% | Pared: 50% | Piso: 20%</div>
                        </div>
                        <div class="reflectance-option" onclick="selectReflectance('baja')">
                            <div class="reflectance-name">Baja</div>
                            <div class="reflectance-value">Techo: 50% | Pared: 30% | Piso: 10%</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group-calc">
                    <label for="operating-hours">Horas anuales de operación:</label>
                    <input type="number" id="operating-hours" min="0" max="8760" step="100" value="4000">
                    <div class="range-info">0 - 8760 horas (1 año completo)</div>
                </div>
                
                <div class="form-group-calc">
                    <label for="maintenance-factor">Factor de mantenimiento:</label>
                    <input type="range" id="maintenance-factor" min="0.5" max="0.9" step="0.05" value="0.8">
                    <div class="range-info">
                        <span>Bajo (0.5)</span>
                        <span id="maintenance-value">0.8</span>
                        <span>Alto (0.9)</span>
                    </div>
                </div>
                
                <div class="form-group-calc">
                    <label>Seleccione el modelo de luminaria:</label>
                    <div class="luminaire-model selected" onclick="selectLuminaire('ALO13')">
                        <div class="luminaire-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="luminaire-info">
                            <div class="luminaire-code">REBL ALO13 UVOLT SWW3 80CRI DWH M2</div>
                            <div class="luminaire-specs">
                                <strong>Lúmenes:</strong> 15,000 | 
                                <strong>Watts:</strong> 100W | 
                                <strong>Temp:</strong> 4000K | 
                                <strong>LPW:</strong> 163
                            </div>
                        </div>
                    </div>
                    
                    <div class="luminaire-model" onclick="selectLuminaire('ALO16')">
                        <div class="luminaire-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="luminaire-info">
                            <div class="luminaire-code">REBL ALO16 UVOLT SWW3 80CRI DWH M2</div>
                            <div class="luminaire-specs">
                                <strong>Lúmenes:</strong> 27,000 | 
                                <strong>Watts:</strong> 170W | 
                                <strong>Temp:</strong> 4000K | 
                                <strong>LPW:</strong> 164
                            </div>
                        </div>
                    </div>
                    
                    <div class="luminaire-summary" id="selected-lum-summary">
                        <div><strong>Seleccionado:</strong> REBL ALO13</div>
                        <div><strong>Lúmenes:</strong> 15,000</div>
                        <div><strong>Watts:</strong> 100W</div>
                    </div>
                </div>
                
                <div class="form-group-calc">
                    <label>Seleccione la tarifa eléctrica:</label>
                    <select id="tariff">
                        <option value="3.50">Tarifa DAC (Demanda Alta) - $3.50/kWh</option>
                        <option value="2.80">Tarifa GDMTH (Gran Demanda) - $2.80/kWh</option>
                        <option value="1.20">Tarifa HS (Hora Sencilla) - $1.20/kWh</option>
                        <option value="custom">Tarifa personalizada</option>
                    </select>
                    <div id="custom-tariff-container" style="display: none; margin-top: 10px;">
                        <input type="number" id="custom-tariff" min="0.5" max="10" step="0.01" value="3.50" placeholder="Precio por kWh">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="calculate-btn" id="calculate">
                        <i class="fas fa-bolt"></i> Calcular
                    </button>
                    <button class="save-btn" id="saveProject">
                        <i class="fas fa-save"></i> Guardar Proyecto
                    </button>
                    <button class="reset-btn" id="reset">
                        <i class="fas fa-redo"></i> Reiniciar
                    </button>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title">
                    <span><i class="fas fa-chart-bar"></i> Resultados y Cotización</span>
                    <div class="export-options">
                        <button class="export-option" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="export-option" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </h2>
                
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-title">Nivel de iluminación requerido</div>
                        <div class="result-value" id="required-lux">500 lux</div>
                        <div class="result-detail">Según NOM-STPS-025</div>
                    </div>
                    
                    <div class="result-card">
                        <div class="result-title">Luminarias necesarias</div>
                        <div class="result-value" id="num-luminaires">0</div>
                        <div class="result-detail" id="luminaire-detail">Cantidad estimada</div>
                    </div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">Distribución recomendada</div>
                    <div class="result-value" id="distribution">0 x 0</div>
                    <div class="result-detail" id="distribution-detail">Filas x Columnas</div>
                </div>
                
                <div class="cost-analysis">
                    <div class="cost-title">
                        <span><i class="fas fa-money-bill-wave"></i> Análisis de Costos de Operación</span>
                        <button class="quote-btn" id="sendQuote" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-tags"></i> Solicitar Precios
                        </button>
                    </div>
                    
                    <div class="cost-grid">
                        <div class="cost-item">
                            <div class="cost-label">Consumo anual de energía</div>
                            <div class="cost-value" id="annual-consumption">0 kWh</div>
                            <div class="cost-subtext" id="annual-consumption-detail">Para 4,000 horas/año</div>
                        </div>
                        
                        <div class="cost-item">
                            <div class="cost-label">Costo anual de electricidad</div>
                            <div class="cost-value" id="annual-cost">$0 MXN</div>
                            <div class="cost-subtext" id="tariff-display">Tarifa: $3.50/kWh</div>
                        </div>
                        
                        <div class="cost-item">
                            <div class="cost-label">Costo mensual promedio</div>
                            <div class="cost-value" id="monthly-cost">$0 MXN</div>
                            <div class="cost-subtext">Aproximado</div>
                        </div>
                        
                        <div class="cost-item">
                            <div class="cost-label">Potencia total instalada</div>
                            <div class="cost-value" id="total-power">0 kW</div>
                            <div class="cost-subtext" id="power-detail">0 W totales</div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista de Planta 2D MEJORADA -->
                <div class="plant-view">
                    <div class="plant-title">
                        <i class="fas fa-th-large"></i> Vista de Planta - Distribución de Luminarias
                    </div>
                    <div class="plant-container" id="plantContainer">
                        <!-- Vista de planta se generará aquí -->
                    </div>
                    <div class="plant-legend">
                        <div class="legend-item">
                            <div class="legend-color legend-luminaire"></div>
                            <span>Luminaria</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-dimension"></div>
                            <span>Dimensiones</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-separation"></div>
                            <span>Separación entre luminarias</span>
                        </div>
                    </div>
                </div>
                
                <div class="result-card" style="margin-top: 20px;">
                    <div class="result-title">Información Técnica</div>
                    <div id="technical-info">
                        <p><strong>Factor de utilización:</strong> <span id="utilization-factor">0.00</span></p>
                        <p><strong>Factor de reflectancia:</strong> <span id="reflectance-factor">Media</span></p>
                        <p><strong>Factor de mantenimiento:</strong> <span id="maintenance-display">0.8</span></p>
                        <p><strong>Área iluminada:</strong> <span id="area-illuminated">0 m²</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 SAVARSA - Servicios Administrativos Varan | Todos los derechos reservados</p>
            <p>Calculadora Guía de Diseño de Iluminación para Nave Industrial Simple</p>
            <p style="font-size: 0.8rem; margin-top: 10px;">Datos guardados localmente en tu navegador</p>
        </footer>
    </div>

    <script>
        // Datos del cliente
        let clientData = {
            name: "",
            company: "",
            email: "",
            phone: "",
            projectName: "",
            address: "",
            projectType: "industrial",
            projectStatus: "cotizacion",
            notes: "",
            lastSave: null
        };

        // Datos del cálculo actual
        let currentCalculation = {
            timestamp: null,
            data: {}
        };

        // Datos de las luminarias
        const luminaires = {
            'ALO13': {
                name: 'REBL ALO13 UVOLT SWW3 80CRI DWH M2',
                lumens: 15000,
                watts: 100,
                colorTemp: '4000K',
                lpw: 163,
                voltage: 'UVOLT (120 - 347V)',
                palletQty: 72
            },
            'ALO16': {
                name: 'REBL ALO16 UVOLT SWW3 80CRI DWH M2',
                lumens: 27000,
                watts: 170,
                colorTemp: '4000K',
                lpw: 164,
                voltage: 'UVOLT (120 - 347V)',
                palletQty: 36
            }
        };

        // Factores de reflectancia
        const reflectanceFactors = {
            'alta': { ceiling: 0.80, walls: 0.70, floor: 0.30, name: 'Alta', utilizationMultiplier: 1.15 },
            'media': { ceiling: 0.70, walls: 0.50, floor: 0.20, name: 'Media', utilizationMultiplier: 1.00 },
            'baja': { ceiling: 0.50, walls: 0.30, floor: 0.10, name: 'Baja', utilizationMultiplier: 0.85 }
        };

        // Variables globales
        let selectedLuminaire = 'ALO13';
        let selectedReflectance = 'media';
        let currentRows = 0;
        let currentColumns = 0;
        let currentDistanceX = 0;
        let currentDistanceY = 0;
        let currentWallDistanceX = 0;
        let currentWallDistanceY = 0;
        let autoSaveTimer = null;

        // Mostrar modal al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos guardados
            loadSavedData();
            
            // Configurar eventos del modal
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelForm').addEventListener('click', closeModal);
            document.getElementById('clientForm').addEventListener('submit', saveClientData);
            
            // Configurar otros eventos
            document.getElementById('tariff').addEventListener('change', toggleCustomTariff);
            document.getElementById('maintenance-factor').addEventListener('input', updateMaintenanceValue);
            document.getElementById('calculate').addEventListener('click', calculateLuminaires);
            document.getElementById('reset').addEventListener('click', resetForm);
            document.getElementById('sendQuote').addEventListener('click', sendQuote);
            document.getElementById('saveProject').addEventListener('click', saveProject);
            
            // Configurar auto-guardado para campos de entrada
            setupAutoSave();
            
            // Mostrar proyectos guardados si existen
            showSavedProjects();
            
            // Si ya hay datos del cliente, no mostrar modal
            if (clientData.name && clientData.email) {
                showClientSummary();
            } else {
                document.getElementById('clientModal').style.display = 'flex';
            }
            
            // Seleccionar primera luminaria por defecto
            selectLuminaire('ALO13');
        });

        // Configurar auto-guardado
        function setupAutoSave() {
            // Lista de campos para auto-guardar
            const autoSaveFields = [
                'length', 'width', 'height', 'work-plane', 'activity',
                'operating-hours', 'maintenance-factor', 'custom-tariff'
            ];
            
            autoSaveFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('change', autoSaveCalculation);
                    element.addEventListener('input', () => {
                        clearTimeout(autoSaveTimer);
                        autoSaveTimer = setTimeout(autoSaveCalculation, 2000);
                    });
                }
            });
            
            // También auto-guardar cuando se seleccionan opciones
            document.querySelectorAll('.reflectance-option').forEach(option => {
                option.addEventListener('click', autoSaveCalculation);
            });
            
            document.querySelectorAll('.luminaire-model').forEach(model => {
                model.addEventListener('click', autoSaveCalculation);
            });
            
            document.getElementById('tariff').addEventListener('change', autoSaveCalculation);
        }

        // Auto-guardar cálculo
        function autoSaveCalculation() {
            if (!clientData.name) return;
            
            const calculationData = {
                client: clientData,
                inputs: {
                    length: document.getElementById('length').value,
                    width: document.getElementById('width').value,
                    height: document.getElementById('height').value,
                    workPlane: document.getElementById('work-plane').value,
                    activity: document.getElementById('activity').value,
                    operatingHours: document.getElementById('operating-hours').value,
                    maintenanceFactor: document.getElementById('maintenance-factor').value,
                    luminaire: selectedLuminaire,
                    reflectance: selectedReflectance,
                    tariff: document.getElementById('tariff').value,
                    customTariff: document.getElementById('custom-tariff').value
                },
                timestamp: new Date().toISOString()
            };
            
            // Guardar en localStorage
            localStorage.setItem('savarsa_last_calculation', JSON.stringify(calculationData));
            
            // Mostrar notificación
            showAutoSaveNotification();
            
            // Actualizar info de último guardado
            updateLastSaveInfo();
        }

        // Mostrar notificación de auto-guardado
        function showAutoSaveNotification() {
            const notification = document.getElementById('autoSaveNotification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Actualizar info de último guardado
        function updateLastSaveInfo() {
            const lastSave = localStorage.getItem('savarsa_last_calculation');
            if (lastSave) {
                const data = JSON.parse(lastSave);
                const date = new Date(data.timestamp);
                document.getElementById('lastSaveInfo').textContent = 
                    `Guardado: ${date.toLocaleTimeString()}`;
            }
        }

        // Cargar datos guardados
        function loadSavedData() {
            // Cargar datos del cliente
            const savedClientData = localStorage.getItem('savarsa_client_data');
            if (savedClientData) {
                clientData = JSON.parse(savedClientData);
            }
            
            // Cargar últimos cálculos
            const savedCalculation = localStorage.getItem('savarsa_last_calculation');
            if (savedCalculation) {
                const calculation = JSON.parse(savedCalculation);
                loadCalculationData(calculation.inputs);
                updateLastSaveInfo();
            }
        }

        // Cargar datos de cálculo
        function loadCalculationData(inputs) {
            if (!inputs) return;
            
            document.getElementById('length').value = inputs.length || 30;
            document.getElementById('width').value = inputs.width || 15;
            document.getElementById('height').value = inputs.height || 6;
            document.getElementById('work-plane').value = inputs.workPlane || 0.8;
            document.getElementById('activity').value = inputs.activity || 500;
            document.getElementById('operating-hours').value = inputs.operatingHours || 4000;
            document.getElementById('maintenance-factor').value = inputs.maintenanceFactor || 0.8;
            document.getElementById('maintenance-value').textContent = inputs.maintenanceFactor || 0.8;
            
            if (inputs.luminaire) {
                selectLuminaire(inputs.luminaire);
            }
            
            if (inputs.reflectance) {
                selectReflectance(inputs.reflectance);
            }
            
            if (inputs.tariff) {
                document.getElementById('tariff').value = inputs.tariff;
                toggleCustomTariff();
                if (inputs.tariff === 'custom' && inputs.customTariff) {
                    document.getElementById('custom-tariff').value = inputs.customTariff;
                }
            }
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        // Editar datos del cliente
        function editClientData() {
            // Cargar datos actuales en el formulario
            document.getElementById('clientName').value = clientData.name;
            document.getElementById('clientCompany').value = clientData.company;
            document.getElementById('clientEmail').value = clientData.email;
            document.getElementById('clientPhone').value = clientData.phone;
            document.getElementById('projectName').value = clientData.projectName;
            document.getElementById('projectAddress').value = clientData.address;
            document.getElementById('projectType').value = clientData.projectType;
            document.getElementById('projectStatus').value = clientData.projectStatus;
            document.getElementById('projectNotes').value = clientData.notes;
            
            // Mostrar modal
            document.getElementById('clientModal').style.display = 'flex';
        }

        // Guardar datos del cliente
        function saveClientData(e) {
            e.preventDefault();
            
            clientData = {
                name: document.getElementById('clientName').value,
                company: document.getElementById('clientCompany').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                projectName: document.getElementById('projectName').value,
                address: document.getElementById('projectAddress').value,
                projectType: document.getElementById('projectType').value,
                projectStatus: document.getElementById('projectStatus').value,
                notes: document.getElementById('projectNotes').value,
                lastSave: new Date().toISOString()
            };
            
            // Guardar en localStorage
            localStorage.setItem('savarsa_client_data', JSON.stringify(clientData));
            
            // Guardar proyecto en lista de proyectos
            saveProjectToList();
            
            // Mostrar resumen del cliente
            showClientSummary();
            
            // Mostrar proyectos guardados
            showSavedProjects();
            
            // Cerrar modal
            closeModal();
            
            // Calcular automáticamente
            calculateLuminaires();
        }

        // Mostrar resumen del cliente
        function showClientSummary() {
            const summary = document.getElementById('clientSummary');
            const infoGrid = document.getElementById('clientInfoGrid');
            
            infoGrid.innerHTML = `
                <div class="client-info-item">
                    <span class="client-info-label">Cliente:</span>
                    <span class="client-info-value">${clientData.name}</span>
                </div>
                <div class="client-info-item">
                    <span class="client-info-label">Proyecto:</span>
                    <span class="client-info-value">${clientData.projectName}</span>
                </div>
                <div class="client-info-item">
                    <span class="client-info-label">Email:</span>
                    <span class="client-info-value">${clientData.email}</span>
                </div>
                <div class="client-info-item">
                    <span class="client-info-label">Teléfono:</span>
                    <span class="client-info-value">${clientData.phone}</span>
                </div>
            `;
            
            summary.style.display = 'block';
        }

        // Guardar proyecto en lista de proyectos
        function saveProjectToList() {
            const projects = JSON.parse(localStorage.getItem('savarsa_projects') || '[]');
            
            // Verificar si el proyecto ya existe
            const existingIndex = projects.findIndex(p => p.projectName === clientData.projectName);
            
            const projectData = {
                ...clientData,
                calculation: getCurrentCalculationData(),
                savedAt: new Date().toISOString()
            };
            
            if (existingIndex !== -1) {
                // Actualizar proyecto existente
                projects[existingIndex] = projectData;
            } else {
                // Agregar nuevo proyecto
                projects.push(projectData);
            }
            
            // Mantener solo los últimos 10 proyectos
            if (projects.length > 10) {
                projects.splice(0, projects.length - 10);
            }
            
            localStorage.setItem('savarsa_projects', JSON.stringify(projects));
        }

        // Obtener datos del cálculo actual
        function getCurrentCalculationData() {
            return {
                length: document.getElementById('length').value,
                width: document.getElementById('width').value,
                height: document.getElementById('height').value,
                requiredLux: document.getElementById('required-lux').textContent,
                numLuminaires: document.getElementById('num-luminaires').textContent,
                distribution: document.getElementById('distribution').textContent,
                annualCost: document.getElementById('annual-cost').textContent,
                totalPower: document.getElementById('total-power').textContent,
                luminaire: selectedLuminaire,
                reflectance: selectedReflectance
            };
        }

        // Mostrar proyectos guardados
        function showSavedProjects() {
            const projects = JSON.parse(localStorage.getItem('savarsa_projects') || '[]');
            const projectsList = document.getElementById('projectsList');
            const savedProjectsSection = document.getElementById('savedProjectsSection');
            
            if (projects.length > 0) {
                savedProjectsSection.style.display = 'block';
                
                projectsList.innerHTML = projects.map((project, index) => `
                    <div class="project-item" onclick="loadProject(${index})">
                        <div class="project-name">${project.projectName}</div>
                        <div class="project-date">${new Date(project.savedAt).toLocaleDateString()}</div>
                    </div>
                `).join('');
            } else {
                savedProjectsSection.style.display = 'none';
            }
        }

        // Cargar proyecto
        function loadProject(index) {
            const projects = JSON.parse(localStorage.getItem('savarsa_projects') || '[]');
            if (projects[index]) {
                const project = projects[index];
                
                // Cargar datos del cliente
                clientData = {
                    name: project.name,
                    company: project.company,
                    email: project.email,
                    phone: project.phone,
                    projectName: project.projectName,
                    address: project.address,
                    projectType: project.projectType,
                    projectStatus: project.projectStatus,
                    notes: project.notes,
                    lastSave: project.savedAt
                };
                
                // Guardar datos del cliente actualizados
                localStorage.setItem('savarsa_client_data', JSON.stringify(clientData));
                
                // Mostrar resumen del cliente
                showClientSummary();
                
                // Cargar datos del cálculo si existen
                if (project.calculation) {
                    // No cargamos directamente los resultados, solo los inputs
                    // para permitir recálculo si es necesario
                }
                
                // Cerrar modal
                closeModal();
                
                // Calcular automáticamente
                calculateLuminaires();
            }
        }

        // Limpiar todos los proyectos
        function clearAllProjects() {
            if (confirm('¿Estás seguro de que deseas eliminar todos los proyectos guardados?')) {
                localStorage.removeItem('savarsa_projects');
                showSavedProjects();
            }
        }

        // Guardar proyecto
        function saveProject() {
            if (!clientData.name) {
                alert("Por favor, complete los datos del cliente primero.");
                document.getElementById('clientModal').style.display = 'flex';
                return;
            }
            
            saveProjectToList();
            showSavedProjects();
            showAutoSaveNotification();
        }

        // Seleccionar luminaria
        function selectLuminaire(code) {
            selectedLuminaire = code;
            
            // Actualizar resumen
            const lum = luminaires[code];
            document.getElementById('selected-lum-summary').innerHTML = `
                <div><strong>Seleccionado:</strong> REBL ${code}</div>
                <div><strong>Lúmenes:</strong> ${lum.lumens.toLocaleString()}</div>
                <div><strong>Watts:</strong> ${lum.watts}W</div>
            `;
            
            // Actualizar estilos
            document.querySelectorAll('.luminaire-model').forEach(model => {
                model.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // Seleccionar reflectancia
        function selectReflectance(type) {
            selectedReflectance = type;
            
            // Actualizar estilos
            document.querySelectorAll('.reflectance-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // Alternar tarifa personalizada
        function toggleCustomTariff() {
            const tariffSelect = document.getElementById('tariff');
            const customContainer = document.getElementById('custom-tariff-container');
            
            if (tariffSelect.value === 'custom') {
                customContainer.style.display = 'block';
            } else {
                customContainer.style.display = 'none';
            }
        }

        // Actualizar valor de mantenimiento
        function updateMaintenanceValue() {
            document.getElementById('maintenance-value').textContent = 
                document.getElementById('maintenance-factor').value;
        }

        // Calcular luminarias
        function calculateLuminaires() {
            // Verificar datos del cliente
            if (!clientData.name) {
                alert("Por favor, complete los datos del cliente primero.");
                document.getElementById('clientModal').style.display = 'flex';
                return;
            }
            
            // Obtener valores del formulario
            const length = parseFloat(document.getElementById('length').value);
            const width = parseFloat(document.getElementById('width').value);
            const height = parseFloat(document.getElementById('height').value);
            const workPlane = parseFloat(document.getElementById('work-plane').value);
            const requiredLux = parseFloat(document.getElementById('activity').value);
            const operatingHours = parseFloat(document.getElementById('operating-hours').value);
            const maintenanceFactor = parseFloat(document.getElementById('maintenance-factor').value);
            
            // Obtener tarifa
            let tariffSelect = document.getElementById('tariff');
            let tariffPrice;
            if (tariffSelect.value === 'custom') {
                tariffPrice = parseFloat(document.getElementById('custom-tariff').value);
            } else {
                tariffPrice = parseFloat(tariffSelect.value);
            }
            
            // Validar datos
            if (!length || !width || !height || !workPlane || isNaN(requiredLux) || !operatingHours) {
                alert("Por favor, complete todos los campos correctamente.");
                return;
            }
            
            // Obtener datos seleccionados
            const lum = luminaires[selectedLuminaire];
            const reflectance = reflectanceFactors[selectedReflectance];
            
            // Calcular altura de montaje
            const mountingHeight = height - workPlane;
            
            // Calcular área
            const area = length * width;
            
            // Factor de utilización base según altura
            let baseUtilizationFactor;
            if (mountingHeight < 4) {
                baseUtilizationFactor = 0.6;
            } else if (mountingHeight >= 4 && mountingHeight < 6) {
                baseUtilizationFactor = 0.5;
            } else if (mountingHeight >= 6 && mountingHeight < 8) {
                baseUtilizationFactor = 0.45;
            } else {
                baseUtilizationFactor = 0.4;
            }
            
            // Aplicar factor de reflectancia
            const utilizationFactor = baseUtilizationFactor * reflectance.utilizationMultiplier;
            
            // Calcular lúmenes totales necesarios
            const totalLumens = (requiredLux * area) / (utilizationFactor * maintenanceFactor);
            
            // Calcular número de luminarias
            const numLuminaires = Math.ceil(totalLumens / lum.lumens);
            
            // Calcular distribución
            const ratio = length / width;
            let rows, columns;
            
            if (ratio > 1.5) {
                rows = Math.ceil(Math.sqrt(numLuminaires / ratio));
                columns = Math.ceil(numLuminaires / rows);
            } else if (ratio < 0.67) {
                columns = Math.ceil(Math.sqrt(numLuminaires * ratio));
                rows = Math.ceil(numLuminaires / columns);
            } else {
                rows = Math.ceil(Math.sqrt(numLuminaires));
                columns = Math.ceil(numLuminaires / rows);
            }
            
            // Ajustar distribución
            while (rows * columns < numLuminaires) {
                if (length > width) {
                    rows++;
                } else {
                    columns++;
                }
            }
            
            // Calcular distancias
            currentDistanceX = length / columns;
            currentDistanceY = width / rows;
            currentWallDistanceX = currentDistanceX / 2;
            currentWallDistanceY = currentDistanceY / 2;
            
            // Guardar para visualización
            currentRows = rows;
            currentColumns = columns;
            
            // Calcular potencia y costos
            const totalWatts = numLuminaires * lum.watts;
            const totalKW = totalWatts / 1000;
            const annualConsumption = (totalWatts * operatingHours) / 1000;
            const annualCost = annualConsumption * tariffPrice;
            const monthlyCost = annualCost / 12;
            
            // Guardar cálculo actual
            currentCalculation = {
                timestamp: new Date().toISOString(),
                data: {
                    length, width, height, workPlane, requiredLux, operatingHours,
                    maintenanceFactor, tariffPrice, luminaire: selectedLuminaire,
                    reflectance: selectedReflectance, numLuminaires, rows, columns,
                    totalWatts, totalKW, annualConsumption, annualCost, monthlyCost
                }
            };
            
            // Auto-guardar
            autoSaveCalculation();
            
            // Mostrar resultados
            document.getElementById('required-lux').textContent = requiredLux.toLocaleString() + ' lux';
            document.getElementById('num-luminaires').textContent = numLuminaires;
            document.getElementById('luminaire-detail').textContent = `Modelo: REBL ${selectedLuminaire}`;
            document.getElementById('distribution').textContent = `${rows} x ${columns}`;
            document.getElementById('distribution-detail').textContent = 
                `Espaciado: ${currentDistanceX.toFixed(1)}m (horizontal), ${currentDistanceY.toFixed(1)}m (vertical)`;
            
            document.getElementById('annual-consumption').textContent = 
                annualConsumption.toLocaleString('es-MX', {maximumFractionDigits: 0}) + ' kWh';
            document.getElementById('annual-consumption-detail').textContent = 
                `Para ${operatingHours.toLocaleString()} horas/año`;
            
            document.getElementById('annual-cost').textContent = 
                '$' + annualCost.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' MXN';
            document.getElementById('tariff-display').textContent = `Tarifa: $${tariffPrice.toFixed(2)}/kWh`;
            
            document.getElementById('monthly-cost').textContent = 
                '$' + monthlyCost.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' MXN';
            
            document.getElementById('total-power').textContent = totalKW.toFixed(2) + ' kW';
            document.getElementById('power-detail').textContent = `${totalWatts.toLocaleString()} W totales`;
            
            // Mostrar información técnica
            document.getElementById('utilization-factor').textContent = utilizationFactor.toFixed(2);
            document.getElementById('reflectance-factor').textContent = reflectance.name;
            document.getElementById('maintenance-display').textContent = maintenanceFactor;
            document.getElementById('area-illuminated').textContent = area.toLocaleString('es-MX') + ' m²';
            
            // Generar vista de planta MEJORADA
            generatePlantView(length, width, rows, columns);
        }

        // Generar vista de planta MEJORADA
        function generatePlantView(length, width, rows, columns) {
            const container = document.getElementById('plantContainer');
            container.innerHTML = '';
            
            // Dimensiones del contenedor
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Escalas con márgenes para mostrar dimensiones
            const margin = 40; // Margen para mostrar dimensiones
            const scaleX = (containerWidth - 2*margin) / length;
            const scaleY = (containerHeight - 2*margin) / width;
            const scale = Math.min(scaleX, scaleY);
            
            // Centro del dibujo
            const centerX = containerWidth / 2;
            const centerY = containerHeight / 2;
            
            // Dibujar piso
            const floor = document.createElement('div');
            floor.className = 'plant-floor';
            floor.style.width = `${length * scale}px`;
            floor.style.height = `${width * scale}px`;
            floor.style.left = `${centerX - (length * scale) / 2}px`;
            floor.style.top = `${centerY - (width * scale) / 2}px`;
            container.appendChild(floor);
            
            // Dibujar paredes
            const walls = [
                { class: 'plant-wall horizontal', top: centerY - (width * scale) / 2, left: centerX - (length * scale) / 2, width: length * scale, height: 3 },
                { class: 'plant-wall horizontal', top: centerY + (width * scale) / 2 - 3, left: centerX - (length * scale) / 2, width: length * scale, height: 3 },
                { class: 'plant-wall vertical', top: centerY - (width * scale) / 2, left: centerX - (length * scale) / 2, width: 3, height: width * scale },
                { class: 'plant-wall vertical', top: centerY - (width * scale) / 2, left: centerX + (length * scale) / 2 - 3, width: 3, height: width * scale }
            ];
            
            walls.forEach(wall => {
                const wallElement = document.createElement('div');
                wallElement.className = wall.class;
                wallElement.style.top = `${wall.top}px`;
                wallElement.style.left = `${wall.left}px`;
                wallElement.style.width = `${wall.width}px`;
                wallElement.style.height = `${wall.height}px`;
                container.appendChild(wallElement);
            });
            
            // Líneas de separación entre luminarias (verticales)
            for (let i = 1; i < columns; i++) {
                const lineX = centerX - (length * scale) / 2 + i * currentDistanceX * scale;
                const line = document.createElement('div');
                line.className = 'separation-line vertical';
                line.style.left = `${lineX}px`;
                line.style.top = `${centerY - (width * scale) / 2}px`;
                line.style.height = `${width * scale}px`;
                container.appendChild(line);
            }
            
            // Líneas de separación entre luminarias (horizontales)
            for (let i = 1; i < rows; i++) {
                const lineY = centerY - (width * scale) / 2 + i * currentDistanceY * scale;
                const line = document.createElement('div');
                line.className = 'separation-line horizontal';
                line.style.left = `${centerX - (length * scale) / 2}px`;
                line.style.top = `${lineY}px`;
                line.style.width = `${length * scale}px`;
                container.appendChild(line);
            }
            
            // Dibujar luminarias
            const lumSize = selectedLuminaire === 'ALO13' ? 12 : 16;
            
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < columns; j++) {
                    const x = centerX - (length * scale) / 2 + currentWallDistanceX * scale + j * currentDistanceX * scale;
                    const y = centerY - (width * scale) / 2 + currentWallDistanceY * scale + i * currentDistanceY * scale;
                    
                    const luminaire = document.createElement('div');
                    luminaire.className = 'plant-luminaire';
                    luminaire.style.width = `${lumSize}px`;
                    luminaire.style.height = `${lumSize}px`;
                    luminaire.style.left = `${x}px`;
                    luminaire.style.top = `${y}px`;
                    luminaire.title = `Luminaria ${i+1}-${j+1}`;
                    container.appendChild(luminaire);
                }
            }
            
            // Agregar dimensiones MEJORADAS
            addPlantDimensions(length, width, scale, centerX, centerY);
        }

        // Agregar dimensiones a la vista de planta MEJORADA
        function addPlantDimensions(length, width, scale, centerX, centerY) {
            const container = document.getElementById('plantContainer');
            
            // Dimensiones totales (horizontal)
            const totalDimY = centerY - (width * scale) / 2 - 15;
            
            const totalLineH = document.createElement('div');
            totalLineH.className = 'dimension-line horizontal';
            totalLineH.style.top = `${totalDimY}px`;
            totalLineH.style.left = `${centerX - (length * scale) / 2}px`;
            totalLineH.style.width = `${length * scale}px`;
            container.appendChild(totalLineH);
            
            const totalTextH = document.createElement('div');
            totalTextH.className = 'dimension-text';
            totalTextH.textContent = `${length.toFixed(1)} m`;
            totalTextH.style.top = `${totalDimY - 10}px`;
            totalTextH.style.left = `${centerX}px`;
            container.appendChild(totalTextH);
            
            // Flechas para dimensiones horizontales
            const arrowLeftH = document.createElement('div');
            arrowLeftH.className = 'dimension-arrow left';
            arrowLeftH.style.top = `${totalDimY - 4}px`;
            arrowLeftH.style.left = `${centerX - (length * scale) / 2}px`;
            container.appendChild(arrowLeftH);
            
            const arrowRightH = document.createElement('div');
            arrowRightH.className = 'dimension-arrow right';
            arrowRightH.style.top = `${totalDimY - 4}px`;
            arrowRightH.style.left = `${centerX + (length * scale) / 2}px`;
            container.appendChild(arrowRightH);
            
            // Dimensiones totales (vertical)
            const totalDimX = centerX - (length * scale) / 2 - 30;
            
            const totalLineV = document.createElement('div');
            totalLineV.className = 'dimension-line vertical';
            totalLineV.style.top = `${centerY - (width * scale) / 2}px`;
            totalLineV.style.left = `${totalDimX}px`;
            totalLineV.style.height = `${width * scale}px`;
            container.appendChild(totalLineV);
            
            const totalTextV = document.createElement('div');
            totalTextV.className = 'dimension-text';
            totalTextV.textContent = `${width.toFixed(1)} m`;
            totalTextV.style.top = `${centerY}px`;
            totalTextV.style.left = `${totalDimX - 25}px`;
            container.appendChild(totalTextV);
            
            // Flechas para dimensiones verticales
            const arrowTopV = document.createElement('div');
            arrowTopV.className = 'dimension-arrow top';
            arrowTopV.style.top = `${centerY - (width * scale) / 2}px`;
            arrowTopV.style.left = `${totalDimX - 4}px`;
            container.appendChild(arrowTopV);
            
            const arrowBottomV = document.createElement('div');
            arrowBottomV.className = 'dimension-arrow bottom';
            arrowBottomV.style.top = `${centerY + (width * scale) / 2}px`;
            arrowBottomV.style.left = `${totalDimX - 4}px`;
            container.appendChild(arrowBottomV);
            
            // Distancia de la primera luminaria a la pared (horizontal)
            if (currentColumns > 0) {
                const wallDistY = centerY - (width * scale) / 2 - 30;
                
                const wallLineH = document.createElement('div');
                wallLineH.className = 'dimension-line horizontal';
                wallLineH.style.top = `${wallDistY}px`;
                wallLineH.style.left = `${centerX - (length * scale) / 2}px`;
                wallLineH.style.width = `${currentWallDistanceX * scale}px`;
                container.appendChild(wallLineH);
                
                const wallTextH = document.createElement('div');
                wallTextH.className = 'dimension-text';
                wallTextH.textContent = `${currentWallDistanceX.toFixed(1)} m`;
                wallTextH.style.top = `${wallDistY - 10}px`;
                wallTextH.style.left = `${centerX - (length * scale) / 2 + (currentWallDistanceX * scale) / 2}px`;
                container.appendChild(wallTextH);
            }
            
            // Distancia entre luminarias (horizontal) si hay más de una columna
            if (currentColumns > 1) {
                const betweenDistY = centerY + (width * scale) / 2 + 15;
                
                const betweenLineH = document.createElement('div');
                betweenLineH.className = 'dimension-line horizontal';
                betweenLineH.style.top = `${betweenDistY}px`;
                betweenLineH.style.left = `${centerX - (length * scale) / 2 + currentWallDistanceX * scale}px`;
                betweenLineH.style.width = `${currentDistanceX * scale}px`;
                container.appendChild(betweenLineH);
                
                const betweenTextH = document.createElement('div');
                betweenTextH.className = 'dimension-text';
                betweenTextH.textContent = `${currentDistanceX.toFixed(1)} m`;
                betweenTextH.style.top = `${betweenDistY + 5}px`;
                betweenTextH.style.left = `${centerX - (length * scale) / 2 + currentWallDistanceX * scale + (currentDistanceX * scale) / 2}px`;
                container.appendChild(betweenTextH);
            }
        }

        // Exportar a PDF
        function exportToPDF() {
            if (!clientData.name) {
                alert("Por favor, complete los datos del cliente primero.");
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(18);
            doc.text("SAVARSA - Cotización de Iluminación Industrial", 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.text("Calculadora Guía de Diseño de Iluminación para Nave Industrial Simple", 105, 22, { align: 'center' });
            
            // Información del cliente
            doc.setFontSize(14);
            doc.text("Datos del Cliente", 20, 35);
            doc.setFontSize(10);
            doc.text(`Cliente: ${clientData.name}`, 20, 42);
            doc.text(`Empresa: ${clientData.company}`, 20, 47);
            doc.text(`Email: ${clientData.email}`, 20, 52);
            doc.text(`Teléfono: ${clientData.phone}`, 20, 57);
            doc.text(`Proyecto: ${clientData.projectName}`, 20, 62);
            doc.text(`Tipo: ${clientData.projectType}`, 20, 67);
            
            // Datos del proyecto
            doc.setFontSize(14);
            doc.text("Datos del Proyecto", 20, 77);
            doc.setFontSize(10);
            doc.text(`Dimensiones: ${document.getElementById('length').value}m x ${document.getElementById('width').value}m`, 20, 84);
            doc.text(`Área: ${(document.getElementById('length').value * document.getElementById('width').value).toFixed(1)} m²`, 20, 89);
            doc.text(`Altura del techo: ${document.getElementById('height').value}m`, 20, 94);
            doc.text(`Nivel de iluminación requerido: ${document.getElementById('required-lux').textContent}`, 20, 99);
            
            // Resultados
            doc.setFontSize(14);
            doc.text("Resultados del Cálculo", 20, 109);
            doc.setFontSize(10);
            doc.text(`Luminarias necesarias: ${document.getElementById('num-luminaires').textContent}`, 20, 116);
            doc.text(`Modelo seleccionado: REBL ${selectedLuminaire}`, 20, 121);
            doc.text(`Distribución: ${document.getElementById('distribution').textContent}`, 20, 126);
            doc.text(`Potencia total: ${document.getElementById('total-power').textContent}`, 20, 131);
            doc.text(`Costo anual de operación: ${document.getElementById('annual-cost').textContent}`, 20, 136);
            
            // Información técnica
            doc.setFontSize(14);
            doc.text("Información Técnica", 20, 146);
            doc.setFontSize(10);
            doc.text(`Factor de utilización: ${document.getElementById('utilization-factor').textContent}`, 20, 153);
            doc.text(`Factor de reflectancia: ${document.getElementById('reflectance-factor').textContent}`, 20, 158);
            doc.text(`Factor de mantenimiento: ${document.getElementById('maintenance-display').textContent}`, 20, 163);
            
            // Pie de página
            doc.setFontSize(8);
            doc.text("Generado por SAVARSA - Servicios Administrativos Varan", 105, 280, { align: 'center' });
            doc.text("Tel: 55 29005186 | Email: epadron@savarsa.com", 105, 285, { align: 'center' });
            doc.text(`Fecha: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 105, 290, { align: 'center' });
            
            // Guardar PDF
            doc.save(`Cotización_${clientData.projectName}_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        // Exportar a Excel
        function exportToExcel() {
            if (!clientData.name) {
                alert("Por favor, complete los datos del cliente primero.");
                return;
            }
            
            // Crear datos para la hoja de cálculo
            const data = [
                ["SAVARSA - Servicios Administrativos Varan"],
                ["Calculadora Guía de Diseño de Iluminación para Nave Industrial Simple"],
                [""],
                ["DATOS DEL CLIENTE"],
                ["Cliente", clientData.name],
                ["Empresa", clientData.company],
                ["Email", clientData.email],
                ["Teléfono", clientData.phone],
                ["Proyecto", clientData.projectName],
                ["Tipo", clientData.projectType],
                ["Dirección", clientData.address],
                ["Estado", clientData.projectStatus],
                [""],
                ["DATOS DEL PROYECTO"],
                ["Longitud (m)", document.getElementById('length').value],
                ["Ancho (m)", document.getElementById('width').value],
                ["Área (m²)", (document.getElementById('length').value * document.getElementById('width').value).toFixed(1)],
                ["Altura del techo (m)", document.getElementById('height').value],
                ["Altura plano trabajo (m)", document.getElementById('work-plane').value],
                ["Nivel de iluminación (lux)", document.getElementById('activity').value],
                ["Horas anuales operación", document.getElementById('operating-hours').value],
                ["Factor de mantenimiento", document.getElementById('maintenance-factor').value],
                ["Factor de reflectancia", document.getElementById('reflectance-factor').textContent],
                ["Tarifa eléctrica", document.getElementById('tariff').options[document.getElementById('tariff').selectedIndex].text],
                [""],
                ["RESULTADOS"],
                ["Luminarias necesarias", document.getElementById('num-luminaires').textContent],
                ["Modelo seleccionado", `REBL ${selectedLuminaire}`],
                ["Distribución", document.getElementById('distribution').textContent],
                ["Espaciado entre luminarias", document.getElementById('distribution-detail').textContent.replace('Espaciado: ', '')],
                ["Potencia total instalada", document.getElementById('total-power').textContent],
                ["Consumo anual de energía", document.getElementById('annual-consumption').textContent],
                ["Costo anual de electricidad", document.getElementById('annual-cost').textContent],
                ["Costo mensual promedio", document.getElementById('monthly-cost').textContent],
                [""],
                ["INFORMACIÓN TÉCNICA"],
                ["Factor de utilización", document.getElementById('utilization-factor').textContent],
                ["Área iluminada", document.getElementById('area-illuminated').textContent],
                [""],
                ["INFORMACIÓN DE CONTACTO"],
                ["SAVARSA - Servicios Administrativos Varan"],
                ["Tel: 55 29005186"],
                ["Email: epadron@savarsa.com"],
                ["Ciudad de México"],
                [""],
                ["Fecha de generación", new Date().toLocaleString()]
            ];
            
            // Crear hoja de cálculo
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Cotización");
            
            // Ajustar anchos de columna
            const wscols = [
                {wch: 35}, // Ancho columna A
                {wch: 35}  // Ancho columna B
            ];
            ws['!cols'] = wscols;
            
            // Guardar archivo
            XLSX.writeFile(wb, `Cotización_${clientData.projectName}_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // Solicitar precios (antes "Enviar Cotización")
        function sendQuote() {
            if (!clientData.name) {
                alert("Por favor, complete los datos del cliente primero.");
                document.getElementById('clientModal').style.display = 'flex';
                return;
            }
            
            // Obtener datos del cálculo
            const projectData = {
                client: clientData,
                calculation: getCurrentCalculationData(),
                timestamp: new Date().toLocaleString(),
                requestType: 'price_quote'
            };
            
            // Simular envío de solicitud de precios
            const emailBody = `
SOLICITUD DE PRECIOS - ILUMINACIÓN INDUSTRIAL

DATOS DEL CLIENTE:
Nombre: ${clientData.name}
Empresa: ${clientData.company}
Email: ${clientData.email}
Teléfono: ${clientData.phone}
Proyecto: ${clientData.projectName}
Tipo: ${clientData.projectType}

DATOS DEL PROYECTO:
Dimensión de la nave: ${projectData.calculation.length}m x ${projectData.calculation.width}m
Altura: ${projectData.calculation.height}m
Nivel de iluminación requerido: ${projectData.calculation.requiredLux}

SOLUCIÓN PROPUESTA:
Modelo de luminaria: REBL ${projectData.calculation.luminaire}
Cantidad de luminarias: ${projectData.calculation.numLuminaires}
Distribución: ${projectData.calculation.distribution}
Potencia total: ${projectData.calculation.totalPower}

COSTO ANUAL DE OPERACIÓN:
${projectData.calculation.annualCost}

SOLICITUD:
El cliente solicita cotización de precios para la solución de iluminación propuesta.

Fecha: ${projectData.timestamp}

---
Generado por: Calculadora Guía de Diseño de Iluminación para Nave Industrial Simple
SAVARSA - Servicios Administrativos Varan
Tel: 55 29005186 | Email: epadron@savarsa.com
            `;
            
            // En un caso real, aquí se haría una petición a un servidor
            alert(`¡Solicitud de precios enviada!\n\nSe ha enviado la solicitud a epadron@savarsa.com\n\nRecibirá nuestra cotización de precios en breve.`);
            
            // Aquí normalmente se haría un fetch() a un endpoint del servidor
            console.log("Solicitud de precios enviada:", projectData);
            console.log("Cuerpo del correo:", emailBody);
            
            // Guardar la solicitud en historial
            saveQuoteRequest(projectData);
        }

        // Guardar solicitud de precios en historial
        function saveQuoteRequest(projectData) {
            const quoteHistory = JSON.parse(localStorage.getItem('savarsa_quote_history') || '[]');
            quoteHistory.push({
                ...projectData,
                requestedAt: new Date().toISOString()
            });
            
            // Mantener solo las últimas 20 solicitudes
            if (quoteHistory.length > 20) {
                quoteHistory.splice(0, quoteHistory.length - 20);
            }
            
            localStorage.setItem('savarsa_quote_history', JSON.stringify(quoteHistory));
        }

        // Reiniciar formulario
        function resetForm() {
            if (confirm("¿Estás seguro de que deseas reiniciar todos los datos? Esto borrará el cálculo actual pero mantendrá los datos del cliente.")) {
                document.getElementById('length').value = 30;
                document.getElementById('width').value = 15;
                document.getElementById('height').value = 6;
                document.getElementById('work-plane').value = 0.8;
                document.getElementById('activity').value = 500;
                document.getElementById('operating-hours').value = 4000;
                document.getElementById('maintenance-factor').value = 0.8;
                document.getElementById('maintenance-value').textContent = '0.8';
                document.getElementById('tariff').value = '3.50';
                document.getElementById('custom-tariff-container').style.display = 'none';
                
                selectLuminaire('ALO13');
                selectReflectance('media');
                
                // Limpiar resultados
                document.getElementById('required-lux').textContent = '500 lux';
                document.getElementById('num-luminaires').textContent = '0';
                document.getElementById('luminaire-detail').textContent = 'Cantidad estimada';
                document.getElementById('distribution').textContent = '0 x 0';
                document.getElementById('distribution-detail').textContent = 'Filas x Columnas';
                document.getElementById('annual-consumption').textContent = '0 kWh';
                document.getElementById('annual-cost').textContent = '$0 MXN';
                document.getElementById('monthly-cost').textContent = '$0 MXN';
                document.getElementById('total-power').textContent = '0 kW';
                
                // Limpiar vista de planta
                document.getElementById('plantContainer').innerHTML = '';
                
                // Limpiar info de último guardado
                document.getElementById('lastSaveInfo').textContent = '';
            }
        }
    </script>
</body>
</html>